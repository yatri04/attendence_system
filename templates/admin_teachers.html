{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">Manage Teachers</h2>
        <p class="text-muted mb-0">Create teacher accounts and assign them to classes</p>
      </div>
      <div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
    
    <!-- Analytics Accounts Info -->
    <div class="alert alert-info mb-4">
      <h6 class="alert-heading"><i class="bi bi-graph-up me-2"></i>Analytics Accounts</h6>
      <p class="mb-2">Create HOD and Principal accounts to provide analytics access:</p>
      <ul class="mb-0">
        <li><strong>HOD (Head of Department):</strong> Select "HOD" role and assign a department for department-specific analytics</li>
        <li><strong>Principal:</strong> Select "Principal" role for institution-wide analytics dashboard</li>
      </ul>
    </div>
  </div>
</div>

<!-- Create Teacher Form -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Create New User (Teacher/HOD/Principal)</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('manage_teachers') }}">
          <input type="hidden" name="action" value="create">
          <div class="row">
            <div class="col-md-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" name="name" required placeholder="e.g., Dr. John Smith">
            </div>
            <div class="col-md-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" required placeholder="e.g., john.smith@university.edu">
            </div>
            <div class="col-md-2">
              <label for="role" class="form-label">Role</label>
              <select class="form-select" id="role" name="role" required onchange="toggleDepartmentField()">
                <option value="teacher">Teacher</option>
                <option value="hod">HOD</option>
                <option value="principal">Principal</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="department_id" class="form-label" id="dept_label" style="display: none;">Department</label>
              <select class="form-select" id="department_id" name="department_id" style="display: none;">
                <option value="">Select Department</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" name="password" required placeholder="Default: teacher123">
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-plus-circle me-2"></i>Create User
              </button>
            </div>
          </div>
        </form>
        
        <script>
        function toggleDepartmentField() {
          const roleSelect = document.getElementById('role');
          const deptLabel = document.getElementById('dept_label');
          const deptSelect = document.getElementById('department_id');
          
          if (roleSelect.value === 'hod') {
            deptLabel.style.display = 'block';
            deptSelect.style.display = 'block';
            deptSelect.required = true;
          } else {
            deptLabel.style.display = 'none';
            deptSelect.style.display = 'none';
            deptSelect.required = false;
          }
        }
        </script>
      </div>
    </div>
  </div>
</div>

<!-- Assign Teacher to Class -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Assign Teacher to Class</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('manage_teachers') }}">
          <input type="hidden" name="action" value="assign_class">
          <div class="row">
            <div class="col-md-5">
              <label for="teacher_id" class="form-label">Select Teacher</label>
              <select class="form-select" id="teacher_id" name="teacher_id" required>
                <option value="">Choose a teacher...</option>
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}">{{ teacher.name }} ({{ teacher.email }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-5">
              <label for="class_id" class="form-label">Select Class</label>
              <select class="form-select" id="class_id" name="class_id" required>
                <option value="">Choose a class...</option>
                {% for class in classes %}
                <option value="{{ class.id }}">{{ class.name }} - {{ class.branch.department.code }}{{ class.branch.code }} (Sem {{ class.semester.number }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-link me-2"></i>Assign
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Teachers List -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Teachers ({{ teachers|length }})</h5>
      </div>
      <div class="card-body">
        {% if teachers %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Assigned Classes</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for teacher in teachers %}
                <tr>
                  <td>{{ teacher.id }}</td>
                  <td><strong>{{ teacher.name }}</strong></td>
                  <td>{{ teacher.email }}</td>
                  <td>
                    {% set teacher_classes = teacher_classes|selectattr('teacher_id', 'equalto', teacher.id)|list %}
                    {% if teacher_classes %}
                      {% for tc in teacher_classes %}
                        <span class="badge bg-primary me-1">{{ tc.class_obj.name }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">No classes assigned</span>
                    {% endif %}
                  </td>
                  <td>{{ teacher.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                            data-teacher-id="{{ teacher.id }}" 
                            data-teacher-name="{{ teacher.name }}" 
                            data-teacher-email="{{ teacher.email }}">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning reset-password-btn" 
                            data-teacher-id="{{ teacher.id }}" 
                            data-teacher-name="{{ teacher.name }}" 
                            data-teacher-role="{{ teacher.role }}" 
                            title="Reset Password">
                      <i class="bi bi-key"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" 
                            data-teacher-id="{{ teacher.id }}" 
                            data-teacher-name="{{ teacher.name }}">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4">
            <p class="text-muted">No teachers created yet.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Class Assignments -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Class Assignments ({{ teacher_classes|length }})</h5>
      </div>
      <div class="card-body">
        {% if teacher_classes %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Teacher</th>
                  <th>Class</th>
                  <th>Branch</th>
                  <th>Semester</th>
                  <th>Assigned Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for tc in teacher_classes %}
                <tr>
                  <td><strong>{{ tc.teacher.name }}</strong><br><small class="text-muted">{{ tc.teacher.email }}</small></td>
                  <td><span class="badge bg-primary">{{ tc.class_obj.name }}</span></td>
                  <td>{{ tc.class_obj.branch.department.code }}{{ tc.class_obj.branch.code }}</td>
                  <td>Sem {{ tc.class_obj.semester.number }}</td>
                  <td>{{ tc.created_at.strftime('%Y-%m-%d') }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-danger remove-assignment-btn" 
                            data-assignment-id="{{ tc.id }}" 
                            data-teacher-name="{{ tc.teacher.name }}" 
                            data-class-name="{{ tc.class_obj.name }}">
                      <i class="bi bi-x-circle"></i> Remove
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4">
            <p class="text-muted">No class assignments yet.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Edit Teacher Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_teachers') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="edit">
          <input type="hidden" id="edit_teacher_id" name="teacher_id">
          
          <div class="mb-3">
            <label for="edit_name" class="form-label">Name</label>
            <input type="text" class="form-control" id="edit_name" name="name" required>
          </div>
          
          <div class="mb-3">
            <label for="edit_email" class="form-label">Email</label>
            <input type="email" class="form-control" id="edit_email" name="email" required>
          </div>
          
          <div class="mb-3">
            <label for="edit_password" class="form-label">New Password (leave blank to keep current)</label>
            <input type="password" class="form-control" id="edit_password" name="password">
            <div class="form-text">Password will be updated only if a new password is provided.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Teacher Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Teacher</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_teachers') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="delete">
          <input type="hidden" id="delete_teacher_id" name="teacher_id">
          
          <p>Are you sure you want to delete the teacher <strong id="delete_teacher_name"></strong>?</p>
          <p class="text-danger">This will also remove all class assignments.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete Teacher</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Assignment Modal -->
<div class="modal fade" id="removeAssignmentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove Class Assignment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_teachers') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="remove_assignment">
          <input type="hidden" id="remove_assignment_id" name="assignment_id">
          
          <p>Are you sure you want to remove <strong id="remove_teacher_name"></strong> from <strong id="remove_class_name"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Remove Assignment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_teachers') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="reset_password">
          <input type="hidden" id="reset_user_id" name="user_id">
          
          <div class="alert alert-info">
            <strong>User:</strong> <span id="reset_user_name"></span> (<span id="reset_user_role"></span>)
          </div>
          
          <div class="mb-3">
            <label for="password_type" class="form-label">Password Type</label>
            <select class="form-select" id="password_type" name="password_type" onchange="togglePasswordFields()">
              <option value="manual">Manual Password</option>
              <option value="auto">Auto-Generated Password</option>
            </select>
          </div>
          
          <div id="manual_password_div">
            <div class="mb-3">
              <label for="new_password" class="form-label">New Password</label>
              <input type="password" class="form-control" id="new_password" name="new_password" required>
              <div class="form-text">Enter a secure password for the user.</div>
            </div>
          </div>
          
          <div id="auto_password_div" style="display: none;">
            <div class="alert alert-warning">
              <i class="bi bi-info-circle me-2"></i>
              A random 8-character password will be generated automatically.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-key me-2"></i>Reset Password
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Event listeners for buttons
document.addEventListener('DOMContentLoaded', function() {
  // Edit teacher buttons
  document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.getAttribute('data-teacher-id');
      const name = this.getAttribute('data-teacher-name');
      const email = this.getAttribute('data-teacher-email');
      
      document.getElementById('edit_teacher_id').value = id;
      document.getElementById('edit_name').value = name;
      document.getElementById('edit_email').value = email;
      new bootstrap.Modal(document.getElementById('editModal')).show();
    });
  });

  // Delete teacher buttons
  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.getAttribute('data-teacher-id');
      const name = this.getAttribute('data-teacher-name');
      
      document.getElementById('delete_teacher_id').value = id;
      document.getElementById('delete_teacher_name').textContent = name;
      new bootstrap.Modal(document.getElementById('deleteModal')).show();
    });
  });

  // Reset password buttons
  document.querySelectorAll('.reset-password-btn').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.getAttribute('data-teacher-id');
      const name = this.getAttribute('data-teacher-name');
      const role = this.getAttribute('data-teacher-role');
      
      document.getElementById('reset_user_id').value = id;
      document.getElementById('reset_user_name').textContent = name;
      document.getElementById('reset_user_role').textContent = role.toUpperCase();
      document.getElementById('new_password').value = '';
      document.getElementById('password_type').value = 'manual';
      togglePasswordFields();
      new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
    });
  });

  // Remove assignment buttons
  document.querySelectorAll('.remove-assignment-btn').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.getAttribute('data-assignment-id');
      const teacherName = this.getAttribute('data-teacher-name');
      const className = this.getAttribute('data-class-name');
      
      document.getElementById('remove_assignment_id').value = id;
      document.getElementById('remove_teacher_name').textContent = teacherName;
      document.getElementById('remove_class_name').textContent = className;
      new bootstrap.Modal(document.getElementById('removeAssignmentModal')).show();
    });
  });
});

function togglePasswordFields() {
  const passwordType = document.getElementById('password_type').value;
  const manualPasswordDiv = document.getElementById('manual_password_div');
  const autoPasswordDiv = document.getElementById('auto_password_div');
  
  if (passwordType === 'manual') {
    manualPasswordDiv.style.display = 'block';
    autoPasswordDiv.style.display = 'none';
    document.getElementById('new_password').required = true;
  } else {
    manualPasswordDiv.style.display = 'none';
    autoPasswordDiv.style.display = 'block';
    document.getElementById('new_password').required = false;
  }
}
</script>
{% endblock %}
