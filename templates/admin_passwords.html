{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">Password Management</h2>
        <p class="text-muted mb-0">Manage passwords for teachers and students</p>
      </div>
      <div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Individual Password Reset -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Reset Individual Password</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('manage_passwords') }}">
          <input type="hidden" name="action" value="reset_password">
          <div class="row">
            <div class="col-md-4">
              <label for="user_id" class="form-label">Select User</label>
              <select class="form-select" id="user_id" name="user_id" required>
                <option value="">Choose a user...</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }} ({{ user.email }}) - {{ user.role.title() }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="password_type" class="form-label">Password Type</label>
              <select class="form-select" id="password_type" name="password_type" required onchange="togglePasswordField()">
                <option value="auto">Auto-generate</option>
                <option value="manual">Manual Entry</option>
              </select>
            </div>
            <div class="col-md-3" id="manual_password_field" style="display: none;">
              <label for="new_password" class="form-label">New Password</label>
              <input type="password" class="form-control" id="new_password" name="new_password" placeholder="Enter new password">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-warning w-100">
                <i class="bi bi-key me-2"></i>Reset Password
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="send_notification" name="send_notification">
                <label class="form-check-label" for="send_notification">
                  Send notification to user
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Password Reset -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Bulk Password Reset</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('manage_passwords') }}">
          <input type="hidden" name="action" value="bulk_reset">
          <div class="row">
            <div class="col-md-3">
              <label for="role" class="form-label">Select Role</label>
              <select class="form-select" id="role" name="role" required>
                <option value="">Choose role...</option>
                <option value="teacher">All Teachers</option>
                <option value="student">All Students</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="bulk_password_type" class="form-label">Password Type</label>
              <select class="form-select" id="bulk_password_type" name="bulk_password_type" required onchange="toggleBulkPasswordField()">
                <option value="auto">Auto-generate</option>
                <option value="manual">Manual Entry</option>
              </select>
            </div>
            <div class="col-md-3" id="bulk_manual_password_field" style="display: none;">
              <label for="bulk_new_password" class="form-label">New Password</label>
              <input type="password" class="form-control" id="bulk_new_password" name="bulk_new_password" placeholder="Enter new password">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to reset passwords for all users of this role?')">
                <i class="bi bi-arrow-clockwise me-2"></i>Bulk Reset
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Upload Passwords -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Bulk Upload Passwords</h5>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('bulk_upload_passwords') }}" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-4">
              <label for="csv_file" class="form-label">CSV File</label>
              <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <div class="col-md-3">
              <label for="password_column" class="form-label">Password Column Name</label>
              <input type="text" class="form-control" id="password_column" name="password_column" value="password" placeholder="password">
            </div>
            <div class="col-md-3">
              <label for="default_password" class="form-label">Default Password (Optional)</label>
              <input type="password" class="form-control" id="default_password" name="default_password" placeholder="Leave empty for auto-generation">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-success w-100">
                <i class="bi bi-upload me-2"></i>Upload
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto_generate_missing" name="auto_generate_missing">
                <label class="form-check-label" for="auto_generate_missing">
                  Auto-generate passwords for empty fields
                </label>
              </div>
            </div>
            <div class="col-md-6">
              <a href="{{ url_for('download_password_template') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-download me-1"></i>Download Template
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Users List with Password Info -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">All Users ({{ users|length }})</h5>
      </div>
      <div class="card-body">
        {% if users %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Class</th>
                  <th>Last Password Change</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user.id }}</td>
                  <td><strong>{{ user.name }}</strong></td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="badge bg-{{ 'primary' if user.role == 'teacher' else 'success' }}">
                      {{ user.role.title() }}
                    </span>
                  </td>
                  <td>
                    {% if user.class_obj %}
                      <span class="badge bg-info">{{ user.class_obj.name }}</span>
                    {% else %}
                      <span class="text-muted">No class</span>
                    {% endif %}
                  </td>
                  <td>
                    {% set last_change = user.password_logs|sort(attribute='timestamp', reverse=true)|first %}
                    {% if last_change %}
                      {{ last_change.timestamp.strftime('%Y-%m-%d %H:%M') }}
                      <br><small class="text-muted">{{ last_change.method.replace('_', ' ').title() }}</small>
                    {% else %}
                      <span class="text-muted">Never</span>
                    {% endif %}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-warning" onclick="quickReset({{ user.id }}, '{{ user.name }}')">
                      <i class="bi bi-key"></i> Reset
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4">
            <p class="text-muted">No users found.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Recent Password Changes -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Recent Password Changes</h5>
      </div>
      <div class="card-body">
        {% if recent_changes %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>User</th>
                  <th>Action</th>
                  <th>Method</th>
                  <th>Admin</th>
                  <th>Timestamp</th>
                  <th>IP Address</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for change in recent_changes %}
                <tr>
                  <td>
                    <strong>{{ change.user.name }}</strong><br>
                    <small class="text-muted">{{ change.user.email }}</small>
                  </td>
                  <td>
                    <span class="badge bg-{{ 'success' if change.action == 'created' else 'warning' if change.action == 'updated' else 'danger' }}">
                      {{ change.action.title() }}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-info">{{ change.method.replace('_', ' ').title() }}</span>
                  </td>
                  <td>{{ change.admin.name }}</td>
                  <td>{{ change.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                  <td><code>{{ change.ip_address or 'N/A' }}</code></td>
                  <td>{{ change.notes or '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-4">
            <p class="text-muted">No password changes recorded yet.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quick Reset Modal -->
<div class="modal fade" id="quickResetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Password Reset</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_passwords') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="reset_password">
          <input type="hidden" id="quick_user_id" name="user_id">
          
          <div class="mb-3">
            <label class="form-label">User:</label>
            <p id="quick_user_name" class="form-control-plaintext fw-bold"></p>
          </div>
          
          <div class="mb-3">
            <label for="quick_password_type" class="form-label">Password Type</label>
            <select class="form-select" id="quick_password_type" name="password_type" required onchange="toggleQuickPasswordField()">
              <option value="auto">Auto-generate</option>
              <option value="manual">Manual Entry</option>
            </select>
          </div>
          
          <div class="mb-3" id="quick_manual_password_field" style="display: none;">
            <label for="quick_new_password" class="form-label">New Password</label>
            <input type="password" class="form-control" id="quick_new_password" name="new_password" placeholder="Enter new password">
          </div>
          
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="quick_send_notification" name="send_notification">
            <label class="form-check-label" for="quick_send_notification">
              Send notification to user
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Reset Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function togglePasswordField() {
  const passwordType = document.getElementById('password_type').value;
  const manualField = document.getElementById('manual_password_field');
  
  if (passwordType === 'manual') {
    manualField.style.display = 'block';
    document.getElementById('new_password').required = true;
  } else {
    manualField.style.display = 'none';
    document.getElementById('new_password').required = false;
  }
}

function toggleBulkPasswordField() {
  const passwordType = document.getElementById('bulk_password_type').value;
  const manualField = document.getElementById('bulk_manual_password_field');
  
  if (passwordType === 'manual') {
    manualField.style.display = 'block';
    document.getElementById('bulk_new_password').required = true;
  } else {
    manualField.style.display = 'none';
    document.getElementById('bulk_new_password').required = false;
  }
}

function toggleQuickPasswordField() {
  const passwordType = document.getElementById('quick_password_type').value;
  const manualField = document.getElementById('quick_manual_password_field');
  
  if (passwordType === 'manual') {
    manualField.style.display = 'block';
    document.getElementById('quick_new_password').required = true;
  } else {
    manualField.style.display = 'none';
    document.getElementById('quick_new_password').required = false;
  }
}

function quickReset(userId, userName) {
  document.getElementById('quick_user_id').value = userId;
  document.getElementById('quick_user_name').textContent = userName;
  new bootstrap.Modal(document.getElementById('quickResetModal')).show();
}
</script>
{% endblock %}
