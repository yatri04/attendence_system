{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1">Student Management</h2>
        <p class="text-muted">Manage students with class-based organization and bulk operations</p>
      </div>
      <div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary me-2">
          <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addStudentModal">
          <i class="bi bi-person-plus me-2"></i>Add Student
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
          <i class="bi bi-upload me-2"></i>Bulk Upload
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-primary text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ students.total }}</h4>
            <p class="card-text">Total Students</p>
          </div>
          <div class="align-self-center">
            <i class="bi bi-people fs-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ classes|length }}</h4>
            <p class="card-text">Classes</p>
          </div>
          <div class="align-self-center">
            <i class="bi bi-building fs-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-info text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ students.items|selectattr('is_active')|list|length }}</h4>
            <p class="card-text">Active Students</p>
          </div>
          <div class="align-self-center">
            <i class="bi bi-person-check fs-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-warning text-white">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ students.items|rejectattr('is_active')|list|length }}</h4>
            <p class="card-text">Inactive Students</p>
          </div>
          <div class="align-self-center">
            <i class="bi bi-person-x fs-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <form method="GET" action="{{ url_for('manage_students_advanced') }}" class="row g-3">
          <div class="col-md-4">
            <label for="class_filter" class="form-label">Filter by Class</label>
            <select class="form-select" id="class_filter" name="class_filter">
              <option value="">All Classes</option>
                {% for class in classes %}
              <option value="{{ class.id }}" {% if class_filter == class.id|string %}selected{% endif %}>
                {{ class.name }} ({{ class_stats.get(class.id, 0) }} students)
              </option>
              {% endfor %}jinja2.exceptions.UndefinedError: 'class_stats' is undefined
              127.0.0.1 - - [04/Oct/2025 21:39:27] "GET /admin/students?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1" 304 -
              127.0.0.1 - - [04/Oct/2025 21:39:27] "GET /admin/students?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1" 304 -
              127.0.0.1 - - [04/Oct/2025 21:39:28] "GET /admin/students?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1" 304 -
          <div class="col-md-4">
            <label for="search" class="form-label">Search Students</label>
            <input type="text" class="form-control" id="search" name="search" 
                   placeholder="Search by name, email, or roll number" value="{{ search_query }}">
            </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search me-2"></i>Search
              </button>
              <a href="{{ url_for('manage_students_advanced') }}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-2"></i>Clear
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Class Overview -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Class Overview</h5>
      </div>
      <div class="card-body">
        {% if classes %}
          <div class="row">
            {% for class in classes %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                  <h6 class="card-title text-primary">{{ class.name }}</h6>
                  <h4 class="text-success">{{ class_stats.get(class.id, 0) }}</h4>
                  <p class="card-text text-muted mb-2">Students</p>
                  <a href="{{ url_for('view_class_students', class_id=class.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye me-1"></i>View Students
                  </a>
            </div>
              </div>
            </div>
            {% endfor %}
            </div>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-building display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No Classes Found</h5>
            <p class="text-muted">Create classes first to manage students.</p>
            <a href="{{ url_for('admin_setup') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>Create Classes
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Students Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Students List</h5>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-success btn-sm" onclick="selectAll()">
            <i class="bi bi-check-all me-1"></i>Select All
          </button>
          <button type="button" class="btn btn-outline-warning btn-sm" onclick="selectNone()">
            <i class="bi bi-x-circle me-1"></i>Select None
          </button>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
            <i class="bi bi-trash me-1"></i>Delete Selected
          </button>
          <button type="button" class="btn btn-outline-info btn-sm" onclick="bulkMove()" id="bulkMoveBtn" disabled>
            <i class="bi bi-arrow-right me-1"></i>Move Selected
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if students.items %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-dark">
                <tr>
                  <th>
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllCheckboxes()">
                  </th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Roll Number</th>
                  <th>Class</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for student in students.items %}
                <tr>
                  <td>
                    <input type="checkbox" class="student-checkbox" value="{{ student.id }}" onchange="updateBulkButtons()">
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                        {{ student.name[0].upper() }}
                      </div>
                      <strong>{{ student.name }}</strong>
                    </div>
                  </td>
                  <td>{{ student.email }}</td>
                  <td>
                    {% if student.roll_number %}
                      <span class="badge bg-secondary">{{ student.roll_number }}</span>
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if student.class_obj %}
                      <span class="badge bg-info">{{ student.class_obj.name }}</span>
                    {% else %}
                      <span class="text-muted">No Class</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if student.is_active %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ student.created_at.strftime('%Y-%m-%d') }}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary edit-student-btn" 
                              data-student-id="{{ student.id }}">
                      <i class="bi bi-pencil"></i>
                    </button>
                      <button type="button" class="btn btn-outline-danger delete-student-btn" 
                              data-student-id="{{ student.id }}" 
                              data-student-name="{{ student.name }}">
                      <i class="bi bi-trash"></i>
                    </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if students.pages > 1 %}
          <nav aria-label="Students pagination">
            <ul class="pagination justify-content-center">
              {% if students.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('manage_students_advanced', page=students.prev_num, class_filter=class_filter, search=search_query) }}">Previous</a>
                </li>
              {% endif %}
              
              {% for page_num in students.iter_pages() %}
                {% if page_num %}
                  {% if page_num != students.page %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('manage_students_advanced', page=page_num, class_filter=class_filter, search=search_query) }}">{{ page_num }}</a>
                    </li>
                  {% else %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% endif %}
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                {% endif %}
              {% endfor %}
              
              {% if students.has_next %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('manage_students_advanced', page=students.next_num, class_filter=class_filter, search=search_query) }}">Next</a>
                </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}
          
        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-people display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No Students Found</h5>
            <p class="text-muted">
              {% if search_query or class_filter %}
                No students match your current filters.
        {% else %}
                No students have been added yet.
              {% endif %}
            </p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
              <i class="bi bi-upload me-2"></i>Upload Students
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Export Button -->
{% if students.items %}
<div class="row mt-3">
  <div class="col-12 text-center">
    <a href="{{ url_for('export_students', class_filter=class_filter, search=search_query) }}" class="btn btn-outline-success">
      <i class="bi bi-download me-2"></i>Export to CSV
    </a>
  </div>
</div>
{% endif %}

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_students_advanced') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="add_single">
          
          <div class="mb-3">
            <label for="student_name" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="student_name" name="name" required>
          </div>
          
          <div class="mb-3">
            <label for="student_email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="student_email" name="email" required>
          </div>
          
          <div class="mb-3">
            <label for="student_roll" class="form-label">Roll Number</label>
            <input type="text" class="form-control" id="student_roll" name="roll_number" required>
          </div>
          
          <div class="mb-3">
            <label for="student_class" class="form-label">Class</label>
            <select class="form-select" id="student_class" name="class_id" required>
              <option value="">Select a class...</option>
              {% for class in classes %}
              <option value="{{ class.id }}">{{ class.name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="student_password" class="form-label">Password</label>
            <input type="password" class="form-control" id="student_password" name="password" 
                   placeholder="Leave empty for default password (student123)">
            <div class="form-text">Leave empty for default password</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-person-plus me-2"></i>Add Student
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkUploadModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bulk Upload Students</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_students_advanced') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="action" value="bulk_upload">
          
          <div class="alert alert-info">
            <h6>CSV Format Required:</h6>
            <p class="mb-2">Your CSV file must have these columns:</p>
            <code>name,email,roll_number,class_name,password</code>
            <br><br>
            <strong>Notes:</strong>
            <ul class="mb-0">
              <li>Include passwords in the CSV file or leave empty for auto-generation</li>
              <li>Use default password for all if specified below</li>
              <li>Class names must match existing classes</li>
              <li>Email addresses must be unique</li>
            </ul>
          </div>
          
          <div class="mb-3">
            <label for="csv_file" class="form-label">Select CSV File</label>
            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
          </div>
          
          <div class="mb-3">
            <label for="default_password" class="form-label">Default Password (Optional)</label>
            <input type="text" class="form-control" id="default_password" name="default_password" 
                   placeholder="Leave empty for random passwords">
          </div>
          
          <div class="text-center">
            <a href="{{ url_for('download_sample_csv') }}" class="btn btn-outline-secondary">
              <i class="bi bi-download me-2"></i>Download Sample CSV
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-upload me-2"></i>Upload Students
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Move Modal -->
<div class="modal fade" id="bulkMoveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Move Selected Students</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('manage_students_advanced') }}">
        <div class="modal-body">
          <input type="hidden" name="action" value="bulk_move">
          <div id="selectedStudentsList"></div>
          
          <div class="mb-3">
            <label for="new_class_id" class="form-label">Move to Class</label>
            <select class="form-select" id="new_class_id" name="new_class_id" required>
              <option value="">Select a class...</option>
              {% for class in classes %}
              <option value="{{ class.id }}">{{ class.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-arrow-right me-2"></i>Move Students
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Bulk operations
function selectAll() {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
  document.getElementById('selectAllCheckbox').checked = true;
  updateBulkButtons();
}

function selectNone() {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('selectAllCheckbox').checked = false;
  updateBulkButtons();
}

function toggleAllCheckboxes() {
  const selectAll = document.getElementById('selectAllCheckbox').checked;
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = selectAll);
  updateBulkButtons();
}

function updateBulkButtons() {
  const selected = document.querySelectorAll('.student-checkbox:checked');
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  const bulkMoveBtn = document.getElementById('bulkMoveBtn');
  
  if (selected.length > 0) {
    bulkDeleteBtn.disabled = false;
    bulkMoveBtn.disabled = false;
  } else {
    bulkDeleteBtn.disabled = true;
    bulkMoveBtn.disabled = true;
  }
}

function bulkDelete() {
  const selected = document.querySelectorAll('.student-checkbox:checked');
  if (selected.length === 0) return;
  
  if (confirm(`Are you sure you want to delete ${selected.length} selected students?`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("manage_students_advanced") }}';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'bulk_delete';
    form.appendChild(actionInput);
    
    selected.forEach(cb => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'student_ids';
      input.value = cb.value;
      form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
  }
}

function bulkMove() {
  const selected = document.querySelectorAll('.student-checkbox:checked');
  if (selected.length === 0) return;
  
  // Update selected students list
  const listDiv = document.getElementById('selectedStudentsList');
  listDiv.innerHTML = `<p><strong>Selected Students (${selected.length}):</strong></p><ul>`;
  
  selected.forEach(cb => {
    const row = cb.closest('tr');
    const name = row.querySelector('td:nth-child(2) strong').textContent;
    listDiv.innerHTML += `<li>${name}</li>`;
  });
  listDiv.innerHTML += '</ul>';
  
  // Show modal
  new bootstrap.Modal(document.getElementById('bulkMoveModal')).show();
}

// Event delegation for individual student action buttons
document.addEventListener('DOMContentLoaded', function() {
  // Edit student button
  document.addEventListener('click', function(e) {
    if (e.target.closest('.edit-student-btn')) {
      const btn = e.target.closest('.edit-student-btn');
      const studentId = btn.dataset.studentId;
      editStudent(studentId);
    }
  });

  // Delete student button
  document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-student-btn')) {
      const btn = e.target.closest('.delete-student-btn');
      const studentId = btn.dataset.studentId;
      const studentName = btn.dataset.studentName;
      deleteStudent(studentId, studentName);
    }
  });
});

function editStudent(studentId) {
  // TODO: Implement edit functionality
  alert('Edit functionality coming soon!');
}

function deleteStudent(studentId, studentName) {
  if (confirm(`Are you sure you want to delete student "${studentName}"?`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("manage_students_advanced") }}';
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'delete';
    form.appendChild(actionInput);
    
    const studentInput = document.createElement('input');
    studentInput.type = 'hidden';
    studentInput.name = 'student_id';
    studentInput.value = studentId;
    form.appendChild(studentInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}
