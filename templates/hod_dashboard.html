{% extends 'base.html' %}
{% block content %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-1"><i class="bi bi-graph-up me-2"></i>HOD Dashboard</h2>
        <p class="text-muted mb-0">{{ stats.department_name }} - Department Analytics</p>
      </div>
      <div class="text-end">
        <span class="badge bg-primary fs-6">{{ stats.total_sessions }} Sessions</span>
        <span class="badge bg-success fs-6 ms-2">{{ stats.avg_attendance }}% Avg</span>
      </div>
    </div>
  </div>
</div>

<!-- Department Statistics Cards with Progress Indicators -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-primary h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-primary mb-0">{{ stats.branches }}</h3>
            <p class="text-muted mb-0">Branches</p>
          </div>
          <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-diagram-3 fs-2 text-primary"></i>
          </div>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-primary" data-width="{{ (stats.branches / 10 * 100) if stats.branches <= 10 else 100 }}"></div>
        </div>
        <small class="text-muted">Department Structure</small>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-success h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-success mb-0">{{ stats.classes }}</h3>
            <p class="text-muted mb-0">Classes</p>
          </div>
          <div class="bg-success bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-people fs-2 text-success"></i>
          </div>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-success" data-width="{{ (stats.classes / 20 * 100) if stats.classes <= 20 else 100 }}"></div>
        </div>
        <small class="text-muted">Active Classes</small>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-info h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-info mb-0">{{ stats.teachers }}</h3>
            <p class="text-muted mb-0">Teachers</p>
          </div>
          <div class="bg-info bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-person-badge fs-2 text-info"></i>
          </div>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-info" data-width="{{ (stats.teachers / 15 * 100) if stats.teachers <= 15 else 100 }}"></div>
        </div>
        <small class="text-muted">Faculty Strength</small>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card border-warning h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-warning mb-0">{{ stats.students }}</h3>
            <p class="text-muted mb-0">Total Students</p>
          </div>
          <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-person-check fs-2 text-warning"></i>
          </div>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-warning" data-width="{{ (stats.students / 200 * 100) if stats.students <= 200 else 100 }}"></div>
        </div>
        <small class="text-muted">Student Population</small>
      </div>
    </div>
  </div>
</div>

<!-- Student Status Cards with Visual Indicators -->
<div class="row mb-4">
  <div class="col-lg-4 col-md-6 mb-3">
    <div class="card border-success h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-success mb-0">{{ stats.active_students }}</h3>
            <p class="text-muted mb-0">Active Students</p>
          </div>
          <div class="bg-success bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-person-check fs-2 text-success"></i>
          </div>
        </div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-success" data-width="{{ (stats.active_students / stats.students * 100) if stats.students > 0 else 0 }}"></div>
        </div>
        <small class="text-muted">{{ ((stats.active_students / stats.students * 100) if stats.students > 0 else 0)|round(1) }}% of total</small>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-6 mb-3">
    <div class="card border-secondary h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-secondary mb-0">{{ stats.alumni_students }}</h3>
            <p class="text-muted mb-0">Alumni</p>
          </div>
          <div class="bg-secondary bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-person-x fs-2 text-secondary"></i>
          </div>
        </div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-secondary" data-width="{{ (stats.alumni_students / stats.students * 100) if stats.students > 0 else 0 }}"></div>
        </div>
        <small class="text-muted">{{ ((stats.alumni_students / stats.students * 100) if stats.students > 0 else 0)|round(1) }}% of total</small>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-6 mb-3">
    <div class="card border-info h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h3 class="card-title text-info mb-0">{{ stats.avg_attendance }}%</h3>
            <p class="text-muted mb-0">Avg Attendance</p>
          </div>
          <div class="bg-info bg-opacity-10 p-3 rounded-circle">
            <i class="bi bi-graph-up fs-2 text-info"></i>
          </div>
        </div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-info" data-width="{{ stats.avg_attendance }}"></div>
        </div>
        <small class="text-muted">Department Performance</small>
      </div>
    </div>
  </div>
</div>

<!-- Class-wise Attendance with Charts -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Class Performance Overview</h5>
      </div>
      <div class="card-body">
        {% if class_attendance %}
          <canvas id="classAttendanceChart" height="100"></canvas>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-graph-down fs-1 text-muted"></i>
            <p class="text-muted mt-2">No class attendance data available</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Quick Stats</h5>
      </div>
      <div class="card-body">
        {% if class_attendance %}
          {% set total_sessions = class_attendance.values()|sum(attribute='sessions') %}
          {% set total_attendance = class_attendance.values()|sum(attribute='total_attendance') %}
          {% set avg_per_session = (total_attendance / total_sessions) if total_sessions > 0 else 0 %}
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Total Sessions</span>
              <span class="fw-bold text-primary">{{ total_sessions }}</span>
            </div>
            <div class="progress mt-1" style="height: 4px;">
              <div class="progress-bar bg-primary" data-width="{{ (total_sessions / 50 * 100) if total_sessions <= 50 else 100 }}"></div>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Total Attendance</span>
              <span class="fw-bold text-success">{{ total_attendance }}</span>
            </div>
            <div class="progress mt-1" style="height: 4px;">
              <div class="progress-bar bg-success" data-width="{{ (total_attendance / 500 * 100) if total_attendance <= 500 else 100 }}"></div>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Avg per Session</span>
              <span class="fw-bold text-info">{{ avg_per_session|round(1) }}</span>
            </div>
            <div class="progress mt-1" style="height: 4px;">
              <div class="progress-bar bg-info" data-width="{{ (avg_per_session / 30 * 100) if avg_per_session <= 30 else 100 }}"></div>
            </div>
          </div>
          
          <div class="mt-3">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Based on {{ class_attendance|length }} classes
            </small>
          </div>
        {% else %}
          <div class="text-center py-3">
            <i class="bi bi-exclamation-circle fs-2 text-muted"></i>
            <p class="text-muted mt-2 mb-0">No data available</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity with Visual Indicators -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Attendance Sessions</h5>
      </div>
      <div class="card-body">
        {% if recent_sessions %}
          <div class="row">
            {% for session in recent_sessions %}
            <div class="col-lg-6 col-xl-4 mb-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">{{ session.class_obj.name if session.class_obj else 'Unknown' }}</h6>
                    {% if session.is_locked %}
                      <span class="badge bg-secondary">Locked</span>
                    {% elif session.expiry < current_time %}
                      <span class="badge bg-danger">Expired</span>
                    {% else %}
                      <span class="badge bg-success">Active</span>
                    {% endif %}
                  </div>
                  
                  <p class="text-muted small mb-2">
                    <i class="bi bi-person-badge me-1"></i>
                    {{ session.teacher.name if session.teacher else 'Unknown' }}
                  </p>
                  
                  <div class="row text-center">
                    <div class="col-6">
                      <div class="border-end">
                        <div class="text-primary fw-bold fs-5">{{ session.attendances|length }}</div>
                        <small class="text-muted">Present</small>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="text-info fw-bold fs-5">{{ session.created_at.strftime('%H:%M') }}</div>
                      <small class="text-muted">Started</small>
                    </div>
                  </div>
                  
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="bi bi-calendar me-1"></i>
                      {{ session.created_at.strftime('%Y-%m-%d') }}
                    </small>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-4">
            <i class="bi bi-calendar-x fs-1 text-muted"></i>
            <p class="text-muted mt-2">No attendance sessions yet</p>
            <small class="text-muted">Sessions will appear here once teachers start marking attendance</small>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Data for JavaScript -->
{% if class_attendance %}
<script type="application/json" id="class-attendance-data">{{ class_attendance|tojson }}</script>
{% endif %}

<!-- JavaScript for Charts and Progress Bars -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Set progress bar widths
  document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
    const width = bar.getAttribute('data-width');
    bar.style.width = width + '%';
  });

  // Class Attendance Chart
  const dataScript = document.getElementById('class-attendance-data');
  if (dataScript) {
    const ctx = document.getElementById('classAttendanceChart').getContext('2d');
    const classData = JSON.parse(dataScript.textContent);
    
    const labels = Object.values(classData).map(item => item.name);
    const sessionsData = Object.values(classData).map(item => item.sessions);
    const attendanceData = Object.values(classData).map(item => item.total_attendance);
    
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Sessions',
          data: sessionsData,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }, {
          label: 'Total Attendance',
          data: attendanceData,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Class Performance Comparison'
          },
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Count'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Classes'
            }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
